# Robotics-ER 高度化 開発フロー (参照用)

常に参照する指示・タスクをここに集約します。完了したらチェックボックスを更新してください。

## タスク一覧
- [x] Vision/Plannerのプロンプト正規化
  - Vision: bboxは0–1000正規化、未検出は`[]`、JSON配列で返すようプロンプトを修正。
  - Planner: アクション選択JSONのフォーマットを明示。
- [x] ERフォールバック (planner-assist)
  - Flashが決定できない/失敗したときにERに単一ステップを問い合わせるフェイルセーフ。
- [x] 進捗・スタック検知
  - ERで`status/progress/comment`を推定し、低進捗が続けば自動再スキャン/再プラン。
- [x] 逆投影補助
  - MuJoCoカメラ行列を使って正規化点/ボックスから床面上の粗い位置を推定し、方位・距離のヒントとして利用。
- [x] ツールコール準備
  - scan/turn/move/approachをツールとして定義し、将来のERツールコールプランニングに対応できるインターフェース設計。
- [x] パラメータ調整
  - キャリブレーション結果（離散ターン速度/時間）を反映し、シミュレーションで検証・チューニング。手順は `calibration_notes.md` 参照。
- [ ] ツールコール型マルチステッププラン対応
  - ERにツール定義とコンテキスト（画像/履歴/進捗）を渡し、`plan` 配列を返すプロンプトを整備。
  - Executorを`plan`配列実行対応に拡張（失敗/中断時は残ステップ破棄→再プラン）。
- [ ] コンテキスト拡充と安全ガード
  - プロンプトに直近ログ・進捗・BBox履歴を含めるユーティリティを追加。
  - 連続移動の最大長・タイムアウトを実行側でクランプし、安全に消化。
- [ ] 高さベース＋履歴利用の速度/時間調整
  - BBox中心±閾値＆高さに応じたステップ長/速度の動的調整。
  - 高さ増減率や連続フレーム差分をログ化し、必要に応じてERへ渡すための構造を用意。
- [ ] テスト追加
  - ツールコールプランのパース/実行キュー管理、コンテキスト生成のユニットテストを追加（old/配下除外）。

## テスト方針
- 追加開発は必ずユニットテストを同時に追加する（old/ 配下は除外）。
- ERやAPI依存部分はモック・ダミーモデルで置き換え、決定ロジック・パース部を検証する。
- 物理シミュレーション依存は最小限にし、数値判定や補正ロジックの単体テストを優先。
- [ ] 進捗・スタック検知
  - ERで`status/progress/comment`を推定し、低進捗が続けば自動再スキャン/再プラン。
- [ ] 逆投影補助
  - MuJoCoカメラ行列を使って正規化点/ボックスから床面上の粗い位置を推定し、方位・距離のヒントとして利用。
- [ ] ツールコール準備
  - scan/turn/move/approachをツールとして定義し、将来のERツールコールプランニングに対応できるインターフェース設計。
- [ ] パラメータ調整
  - キャリブレーション結果（離散ターン速度/時間）を反映し、シミュレーションで検証・チューニング。

## 参照メモ
- `specifications.md` に現行仕様とER高度利用方針を反映済み。変更時は本ファイルも併せて更新。
- Vision/Plannerのプロンプト指針: 0–1000正規化、未検出は空配列、JSON明示。
- 進捗推定の返却例: `{"status": "IN_PROGRESS"|"STALLED"|"COMPLETED", "progress": 0..1, "comment": "..."}`
